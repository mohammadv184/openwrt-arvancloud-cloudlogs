name: Build and Release OpenWrt Package

on:
  push:
    tags:
      - 'v*'
  workflow_dispatch:

env:
  PKG_NAME: arvancloud-cloudlogs
  OPENWRT_VERSION: 24.10.4

jobs:
  build:
    runs-on: ubuntu-latest
    strategy:
      fail-fast: false
      matrix:
        include:
          - platform: x86_64
            url_sdk: https://downloads.openwrt.org/releases/24.10.0/targets/x86/64/openwrt-sdk-24.10.0-x86-64_gcc-13.3.0_musl.Linux-x86_64.tar.zst
            sdk_ver: "24.10"

          - platform: aarch64_generic
            url_sdk: https://downloads.openwrt.org/releases/24.10.0/targets/rockchip/armv8/openwrt-sdk-24.10.0-rockchip-armv8_gcc-13.3.0_musl.Linux-x86_64.tar.zst
            sdk_ver: "24.10"

          - platform: aarch64_cortex-a53
            url_sdk: https://downloads.openwrt.org/releases/24.10.0/targets/mvebu/cortexa53/openwrt-sdk-24.10.0-mvebu-cortexa53_gcc-13.3.0_musl.Linux-x86_64.tar.zst
            sdk_ver: "24.10"

          - platform: aarch64_cortex-a72
            url_sdk: https://downloads.openwrt.org/releases/24.10.0/targets/mvebu/cortexa72/openwrt-sdk-24.10.0-mvebu-cortexa72_gcc-13.3.0_musl.Linux-x86_64.tar.zst
            sdk_ver: "24.10"

          - platform: arm_cortex-a5_vfpv4
            url_sdk: https://downloads.openwrt.org/releases/24.10.0/targets/at91/sama5/openwrt-sdk-24.10.0-at91-sama5_gcc-13.3.0_musl_eabi.Linux-x86_64.tar.zst
            sdk_ver: "24.10"

          - platform: arm_cortex-a7
            url_sdk: https://downloads.openwrt.org/releases/24.10.0/targets/mediatek/mt7629/openwrt-sdk-24.10.0-mediatek-mt7629_gcc-13.3.0_musl_eabi.Linux-x86_64.tar.zst
            sdk_ver: "24.10"

          - platform: arm_cortex-a7_neon-vfpv4
            url_sdk: https://downloads.openwrt.org/releases/24.10.0/targets/sunxi/cortexa7/openwrt-sdk-24.10.0-sunxi-cortexa7_gcc-13.3.0_musl_eabi.Linux-x86_64.tar.zst
            sdk_ver: "24.10"

          - platform: arm_cortex-a8_vfpv3
            url_sdk: https://downloads.openwrt.org/releases/24.10.0/targets/sunxi/cortexa8/openwrt-sdk-24.10.0-sunxi-cortexa8_gcc-13.3.0_musl_eabi.Linux-x86_64.tar.zst
            sdk_ver: "24.10"

          - platform: arm_cortex-a9
            url_sdk: https://downloads.openwrt.org/releases/24.10.0/targets/bcm53xx/generic/openwrt-sdk-24.10.0-bcm53xx-generic_gcc-13.3.0_musl_eabi.Linux-x86_64.tar.zst
            sdk_ver: "24.10"

          - platform: arm_cortex-a9_neon
            url_sdk: https://downloads.openwrt.org/releases/24.10.0/targets/zynq/generic/openwrt-sdk-24.10.0-zynq-generic_gcc-13.3.0_musl_eabi.Linux-x86_64.tar.zst
            sdk_ver: "24.10"

          - platform: arm_cortex-a9_vfpv3-d16
            url_sdk: https://downloads.openwrt.org/releases/24.10.0/targets/mvebu/cortexa9/openwrt-sdk-24.10.0-mvebu-cortexa9_gcc-13.3.0_musl_eabi.Linux-x86_64.tar.zst
            sdk_ver: "24.10"

          - platform: arm_cortex-a15_neon-vfpv4
            url_sdk: https://downloads.openwrt.org/releases/24.10.0/targets/ipq806x/generic/openwrt-sdk-24.10.0-ipq806x-generic_gcc-13.3.0_musl_eabi.Linux-x86_64.tar.zst
            sdk_ver: "24.10"

          - platform: mips_24kc
            url_sdk: https://downloads.openwrt.org/releases/24.10.0/targets/ath79/generic/openwrt-sdk-24.10.0-ath79-generic_gcc-13.3.0_musl.Linux-x86_64.tar.zst
            sdk_ver: "24.10"

          - platform: mips_4kec
            url_sdk: https://downloads.openwrt.org/releases/24.10.0/targets/realtek/rtl838x/openwrt-sdk-24.10.0-realtek-rtl838x_gcc-13.3.0_musl.Linux-x86_64.tar.zst
            sdk_ver: "24.10"

          - platform: mips_mips32
            url_sdk: https://downloads.openwrt.org/releases/24.10.0/targets/bcm53xx/generic/openwrt-sdk-24.10.0-bcm53xx-generic_gcc-13.3.0_musl_eabi.Linux-x86_64.tar.zst
            sdk_ver: "24.10"

          - platform: mipsel_24kc
            url_sdk: https://downloads.openwrt.org/releases/24.10.0/targets/ramips/rt288x/openwrt-sdk-24.10.0-ramips-rt288x_gcc-13.3.0_musl.Linux-x86_64.tar.zst
            sdk_ver: "24.10"

          - platform: mipsel_74kc
            url_sdk: https://downloads.openwrt.org/releases/24.10.0/targets/ramips/rt3883/openwrt-sdk-24.10.0-ramips-rt3883_gcc-13.3.0_musl.Linux-x86_64.tar.zst
            sdk_ver: "24.10"

          - platform: mipsel_mips32
            url_sdk: https://downloads.openwrt.org/releases/24.10.0/targets/bcm47xx/generic/openwrt-sdk-24.10.0-bcm47xx-generic_gcc-13.3.0_musl.Linux-x86_64.tar.zst
            sdk_ver: "24.10"


    steps:
      - name: Install dependencies
        run: |
          sudo apt-get update
          sudo apt-get install -y build-essential clang flex bison g++ gawk \
          gcc-multilib g++-multilib gettext git libncurses5-dev libssl-dev \
          python3-setuptools rsync swig unzip zlib1g-dev file wget rsync
      - name: Checkout code
        uses: actions/checkout@v4

      - name: Extract version from tag
        if: startsWith(github.ref, 'refs/tags/v')
        id: version
        run: |
          VERSION=${GITHUB_REF#refs/tags/v}
          echo "version=$VERSION" >> $GITHUB_OUTPUT
          echo "PKG_VERSION=$VERSION" >> $GITHUB_ENV

      - name: Setup OpenWrt SDK
        run: |
          mkdir -p packages/arvancloud-cloudlogs
          rsync -av --exclude 'packages' ./ packages/arvancloud-cloudlogs
          
          wget ${{ matrix.url_sdk }} -O sdk.tar.xz || {
            echo "Failed to download SDK for ${{ matrix.platform }}"
            exit 1
          }
          
          tar -xf sdk.tar.xz
          mv openwrt-sdk-* sdk
          
          # Verify SDK structure
          if [ ! -d "sdk" ]; then
            echo "Error: SDK directory not found after extraction"
            exit 1
          fi
          
          echo "SDK_PATH=$(pwd)/sdk" >> $GITHUB_ENV
          echo "SDK setup complete"
          
          cat > sdk/feeds.conf << EOF
          src-git base https://github.com/openwrt/openwrt.git;openwrt-${{ matrix.sdk_ver }}
          src-git packages https://github.com/openwrt/packages.git;openwrt-${{ matrix.sdk_ver }}
          src-git routing https://github.com/openwrt/routing.git;openwrt-${{ matrix.sdk_ver }}
          src-git telephony https://github.com/openwrt/telephony.git;openwrt-${{ matrix.sdk_ver }}
          src-link cloudlogs $GITHUB_WORKSPACE/packages
          EOF
          
          cat sdk/feeds.conf
      - name: Update feeds
        run: |
          cd sdk
          ./scripts/feeds update -a

      - name: Install package dependencies
        run: |
          cd sdk
          ./scripts/feeds install -a || true

      - name: Build package
        run: |
          cd sdk
          make defconfig
          make package/arvancloud-cloudlogs/compile V=s
      - name: Find and verify package
        id: find_pkg
        run: |
          cd sdk
          PKG_FILE=$(find bin/packages -name "${PKG_NAME}_*.ipk" 2>/dev/null | head -1)
          
          if [ -z "$PKG_FILE" ]; then
            echo "Error: Package file not found!"
            echo "Searching in bin/packages:"
            find bin/packages -type f -name "*.ipk" || true
            exit 1
          fi
          
          echo "Found package: $PKG_FILE"
          ls -lh "$PKG_FILE"
          echo "package_file=$PKG_FILE" >> $GITHUB_OUTPUT
          echo "package_path=$(pwd)/$PKG_FILE" >> $GITHUB_OUTPUT

      - name: Upload package artifact
        uses: actions/upload-artifact@v4
        with:
          name: ${{ env.PKG_NAME }}-${{ matrix.sdk_ver }}-v${{ env.PKG_VERSION }}
          path: ${{ env.SDK_PATH }}/${{ steps.find_pkg.outputs.package_file }}
          retention-days: 90
          if-no-files-found: error


  create-release:
    needs: build
    runs-on: ubuntu-latest
    if: needs.build.result == 'success'
    
    steps:
      - name: Checkout code
        uses: actions/checkout@v4

      - name: Extract version
        id: version
        run: |
          VERSION=${GITHUB_REF#refs/tags/v}
          echo "version=$VERSION" >> $GITHUB_OUTPUT

      - name: Download all artifacts
        uses: actions/download-artifact@v4
        with:
          path: release-packages
          pattern: ${{ env.PKG_NAME }}-*-v*

      - name: Create checksums
        run: |
          cd release-packages
          find . -name "*.ipk" -exec sh -c 'sha256sum "$1" > "$1.sha256sum"' _ {} \;

      - name: Create GitHub Release
        uses: softprops/action-gh-release@v1
        with:
          name: Release v${{ steps.version.outputs.version }}
          body: |
            ## OpenWrt Arvancloud Cloudlogs Package Release v${{ steps.version.outputs.version }}
            
            ### Installation
            
            Download the appropriate package for your architecture and install:
            ```bash
            opkg install arvancloud-cloudlogs_*.ipk
            ```
            
            
            ### Configuration
            
            1. Edit `/etc/config/arvancloud-cloudlogs`:
               ```
               config arvancloud-cloudlogs 'main'
                   option enabled '1'
                   option api_key 'your-api-key'
               ```
            
            2. Enable and start the service:
               ```bash
               /etc/init.d/arvancloud-cloudlogs enable
               /etc/init.d/arvancloud-cloudlogs start
               ```
            
            ### Verification
            
            Check service status:
            ```bash
            /etc/init.d/arvancloud-cloudlogs status
            ```
          files: |
            release-packages/**/*.ipk
            release-packages/**/*.sha256sum
          draft: false
          prerelease: false
        env:
          GITHUB_TOKEN: ${{ secrets.GITHUB_TOKEN }}
  sync-with-repository:
    needs: build
    runs-on: ubuntu-latest
    if: needs.build.result == 'success'

    steps:
      - name: Checkout code
        uses: actions/checkout@v4

